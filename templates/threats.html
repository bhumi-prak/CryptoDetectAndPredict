{% extends "base.html" %}

{% block title %}Threats - RansomGuard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 fw-bold mb-1">Threat Management</h1>
        <p class="text-muted mb-0">Review and manage detected security threats</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="exportThreats()">
            <i class="bi bi-download"></i> Export
        </button>
        <button class="btn btn-outline-warning" onclick="quarantineAll()">
            <i class="bi bi-shield"></i> Quarantine All
        </button>
        <a href="{{ url_for('scanner_page') }}" class="btn btn-primary">
            <i class="bi bi-search"></i> New Scan
        </a>
    </div>
</div>

<!-- Threat Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-dark border-danger">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle-fill text-danger display-6"></i>
                <div class="h4 mt-2" id="criticalCount">{{ threats.items | selectattr('threat_level', 'equalto', 'critical') | list | length }}</div>
                <div class="text-muted">Critical</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-warning">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-triangle text-warning display-6"></i>
                <div class="h4 mt-2" id="highCount">{{ threats.items | selectattr('threat_level', 'equalto', 'high') | list | length }}</div>
                <div class="text-muted">High</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-info">
            <div class="card-body text-center">
                <i class="bi bi-info-circle text-info display-6"></i>
                <div class="h4 mt-2" id="mediumCount">{{ threats.items | selectattr('threat_level', 'equalto', 'medium') | list | length }}</div>
                <div class="text-muted">Medium</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary">
            <div class="card-body text-center">
                <i class="bi bi-shield text-secondary display-6"></i>
                <div class="h4 mt-2" id="lowCount">{{ threats.items | selectattr('threat_level', 'equalto', 'low') | list | length }}</div>
                <div class="text-muted">Low</div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card bg-dark border-secondary mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Search Threats</label>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control bg-dark border-secondary text-light" 
                           id="searchInput" placeholder="Search by filename or path...">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Threat Level</label>
                <select class="form-select bg-dark border-secondary text-light" id="levelFilter">
                    <option value="">All Levels</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select bg-dark border-secondary text-light" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="quarantined">Quarantined</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date Range</label>
                <select class="form-select bg-dark border-secondary text-light" id="dateFilter">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Threats Table -->
<div class="card bg-dark border-secondary">
    <div class="card-header bg-dark border-secondary">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-list-ul text-secondary me-2"></i>
                Detected Threats ({{ threats.total }})
            </h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="selectAll()">
                    <i class="bi bi-check-square"></i> Select All
                </button>
                <button class="btn btn-outline-secondary" onclick="deselectAll()">
                    <i class="bi bi-square"></i> Deselect All
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if threats.items %}
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th width="30">
                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                        </th>
                        <th>File Information</th>
                        <th>Threat Details</th>
                        <th>Detection Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="threatsTableBody">
                    {% for threat in threats.items %}
                    <tr class="threat-row" data-threat-id="{{ threat.id }}" data-threat-level="{{ threat.threat_level }}" data-status="{% if threat.quarantined %}quarantined{% else %}active{% endif %}">
                        <td>
                            <input type="checkbox" class="form-check-input threat-checkbox" value="{{ threat.id }}">
                        </td>
                        <td>
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="bi bi-file-earmark-text text-muted display-6"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium text-truncate" style="max-width: 250px;" title="{{ threat.file_path }}">
                                        {{ threat.file_path | basename }}
                                    </div>
                                    <div class="text-muted small text-truncate" style="max-width: 250px;">
                                        {{ threat.file_path | dirname }}
                                    </div>
                                    <div class="text-muted small">
                                        {% if threat.file_size %}
                                        {{ (threat.file_size / 1024) | round(1) }} KB
                                        {% endif %}
                                        {% if threat.file_hash %}
                                        â€¢ {{ threat.file_hash[:8] }}...
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="mb-2">
                                {% if threat.threat_level == 'critical' %}
                                <span class="badge bg-danger">Critical</span>
                                {% elif threat.threat_level == 'high' %}
                                <span class="badge bg-warning">High</span>
                                {% elif threat.threat_level == 'medium' %}
                                <span class="badge bg-info">Medium</span>
                                {% else %}
                                <span class="badge bg-secondary">Low</span>
                                {% endif %}
                            </div>
                            <div class="small text-muted">
                                {{ threat.threat_type | replace('_', ' ') | title }}
                            </div>
                            <div class="small">
                                Confidence: <span class="text-warning">{{ "%.1f"|format(threat.confidence_score * 100) }}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                {{ threat.detected_at.strftime('%Y-%m-%d') }}
                            </div>
                            <div class="small text-muted">
                                {{ threat.detected_at.strftime('%H:%M:%S') }}
                            </div>
                        </td>
                        <td>
                            {% if threat.quarantined %}
                            <span class="badge bg-warning">
                                <i class="bi bi-shield"></i> Quarantined
                            </span>
                            {% else %}
                            <span class="badge bg-danger">
                                <i class="bi bi-exclamation-triangle"></i> Active
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if not threat.quarantined %}
                                <button class="btn btn-outline-warning" onclick="quarantineThreat({{ threat.id }})" title="Quarantine">
                                    <i class="bi bi-shield"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-outline-success" onclick="restoreThreat({{ threat.id }})" title="Restore">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-info" onclick="viewThreatDetails({{ threat.id }})" title="Details">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="reportFalsePositive({{ threat.id }})" title="Report False Positive">
                                    <i class="bi bi-flag"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if threats.pages > 1 %}
        <div class="card-footer bg-dark border-secondary">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if threats.has_prev %}
                    <li class="page-item">
                        <a class="page-link bg-dark border-secondary text-light" href="{{ url_for('threats', page=threats.prev_num) }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in threats.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != threats.page %}
                            <li class="page-item">
                                <a class="page-link bg-dark border-secondary text-light" href="{{ url_for('threats', page=page_num) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link bg-primary border-primary">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link bg-dark border-secondary text-muted">â€¦</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if threats.has_next %}
                    <li class="page-item">
                        <a class="page-link bg-dark border-secondary text-light" href="{{ url_for('threats', page=threats.next_num) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-shield-check text-success display-1"></i>
            <h4 class="text-success mt-3">No threats detected!</h4>
            <p class="text-muted">Your system is currently clean. Run a scan to check for new threats.</p>
            <a href="{{ url_for('scanner_page') }}" class="btn btn-primary mt-3">
                <i class="bi bi-search"></i> Start New Scan
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Threat Details Modal -->
<div class="modal fade" id="threatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Threat Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="threatModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="modalQuarantineBtn">Quarantine</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/threats.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeThreatsPage();
    
    // Initialize search functionality
    document.getElementById('searchInput').addEventListener('input', debounce(filterThreats, 300));
    document.getElementById('levelFilter').addEventListener('change', filterThreats);
    document.getElementById('statusFilter').addEventListener('change', filterThreats);
    document.getElementById('dateFilter').addEventListener('change', filterThreats);
    
    // Initialize select all functionality
    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function filterThreats() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const level = document.getElementById('levelFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    const rows = document.querySelectorAll('.threat-row');
    
    rows.forEach(row => {
        const filePath = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const threatLevel = row.dataset.threatLevel;
        const threatStatus = row.dataset.status;
        
        const matchesSearch = !search || filePath.includes(search);
        const matchesLevel = !level || threatLevel === level;
        const matchesStatus = !status || threatStatus === status;
        
        if (matchesSearch && matchesLevel && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.threat-checkbox');
    
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('.threat-row');
        if (row.style.display !== 'none') {
            checkbox.checked = selectAll;
        }
    });
}

function selectAll() {
    document.getElementById('selectAllCheckbox').checked = true;
    toggleSelectAll();
}

function deselectAll() {
    document.getElementById('selectAllCheckbox').checked = false;
    toggleSelectAll();
}

function quarantineThreat(threatId) {
    if (confirm('Quarantine this threat? The file will be safely isolated and backed up.')) {
        window.location.href = `/quarantine_threat/${threatId}`;
    }
}

function restoreThreat(threatId) {
    if (confirm('Restore this file from quarantine? This will move it back to its original location.')) {
        // In a real implementation, this would call a restore endpoint
        alert('Restore functionality coming soon!');
    }
}

function viewThreatDetails(threatId) {
    // Show threat details in modal
    const modal = new bootstrap.Modal(document.getElementById('threatModal'));
    
    // Load threat details (in real implementation, this would fetch from server)
    document.getElementById('threatModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Simulate loading threat details
    setTimeout(() => {
        document.getElementById('threatModalBody').innerHTML = `
            <h6>File Information</h6>
            <table class="table table-dark table-sm">
                <tr><th>Path:</th><td>/path/to/suspicious/file.exe</td></tr>
                <tr><th>Size:</th><td>1.2 MB</td></tr>
                <tr><th>Hash:</th><td>abc123def456...</td></tr>
                <tr><th>Created:</th><td>2024-01-15 10:30:00</td></tr>
            </table>
            
            <h6 class="mt-3">Threat Analysis</h6>
            <table class="table table-dark table-sm">
                <tr><th>Type:</th><td>Ransomware Indicator</td></tr>
                <tr><th>Level:</th><td><span class="badge bg-warning">High</span></td></tr>
                <tr><th>Confidence:</th><td>87.5%</td></tr>
                <tr><th>Detection Method:</th><td>Entropy Analysis, ML Prediction</td></tr>
            </table>
            
            <h6 class="mt-3">Risk Factors</h6>
            <ul class="list-unstyled">
                <li><i class="bi bi-exclamation-triangle text-warning me-2"></i>High entropy (possible encryption)</li>
                <li><i class="bi bi-clock text-info me-2"></i>Recently created file</li>
                <li><i class="bi bi-cpu text-danger me-2"></i>ML model flagged as suspicious</li>
            </ul>
        `;
    }, 1000);
}

function reportFalsePositive(threatId) {
    if (confirm('Report this as a false positive? This will help improve our detection accuracy.')) {
        alert('Thank you for the feedback! This has been reported for review.');
    }
}

function quarantineAll() {
    const selected = document.querySelectorAll('.threat-checkbox:checked');
    if (selected.length === 0) {
        alert('Please select threats to quarantine.');
        return;
    }
    
    if (confirm(`Quarantine ${selected.length} selected threat(s)?`)) {
        // In real implementation, this would send a batch quarantine request
        alert(`Quarantining ${selected.length} threats...`);
    }
}

function exportThreats() {
    // In real implementation, this would generate and download a report
    alert('Export functionality coming soon!');
}

function applyFilters() {
    filterThreats();
}
</script>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.threat-row {
    transition: background-color 0.2s ease;
}

.modal-content {
    border: 1px solid var(--bs-border-color);
}

.page-link {
    color: var(--bs-light);
    background-color: var(--bs-dark);
    border-color: var(--bs-border-color);
}

.page-link:hover {
    color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.1);
    border-color: var(--bs-primary);
}
</style>
{% endblock %}
